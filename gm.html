<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>GM dApp (Base) — ENS-safe</title>

  <!-- ethers UMD -->
  <script src="https://unpkg.com/ethers@6.11.1/dist/ethers.umd.min.js"></script>

  <style>
    body { font-family: Inter, Arial, sans-serif; max-width:900px; margin:24px auto; padding:0 16px; color:#111 }
    header { display:flex; gap:12px; align-items:center; margin-bottom:18px; }
    button { padding:8px 12px; border-radius:8px; border:1px solid #ddd; background:#fff; cursor:pointer }
    button:disabled { opacity:0.5; cursor:not-allowed }
    .row { display:flex; gap:8px; align-items:center; margin:8px 0; flex-wrap:wrap; }
    .status { padding:12px; border-radius:8px; background:#f8f9fb; border:1px solid #eee; }
    code { background:#f2f2f2; padding:2px 6px; border-radius:6px; font-size:0.95em; }
  </style>
</head>
<body>
  <header>
    <h1 style="margin:0">GM dApp — Base v.1.3</h1>
    <div style="margin-left:auto">
      <button id="connectBtn">Połącz MetaMask</button>
      <button id="disconnectBtn" disabled>Rozłącz</button>
    </div>
  </header>

  <div class="status" id="appStatus">
    <div><strong>Stan:</strong> <span id="statusText">Niepołączony</span></div>
    <div><strong>Konto:</strong> <span id="account">—</span></div>
    <div><strong>Sieć (chainId):</strong> <span id="chain">—</span></div>
    <div><strong>Opłata (0.01 USD) ≈</strong> <span id="feeEth">—</span> ETH</div>
  </div>

  <div class="row" style="margin-top:16px">
    <button id="fetchFeeBtn" disabled>Pobierz aktualną opłatę</button>
    <button id="sayGmBtn" disabled>Say GM (zapłać)</button>
  </div>

  <div style="margin-top:12px">
    <strong>Tx status:</strong>
    <div id="txStatus">—</div>
  </div>

<script>
(() => {
  // === KONFIGURACJA: ustaw swój adres kontraktu poniżej ===
  const GM_CONTRACT_ADDRESS = "0xYourContractAddressHere"; // <- ZAMIENIĆ!
  const GM_ABI = [
    "function sayGM() external payable",
    "function getGmFeeInEth() view returns (uint256)"
  ];

  // UI refs
  const connectBtn = document.getElementById("connectBtn");
  const disconnectBtn = document.getElementById("disconnectBtn");
  const fetchFeeBtn = document.getElementById("fetchFeeBtn");
  const sayGmBtn = document.getElementById("sayGmBtn");
  const statusText = document.getElementById("statusText");
  const accountText = document.getElementById("account");
  const chainText = document.getElementById("chain");
  const feeEthText = document.getElementById("feeEth");
  const txStatus = document.getElementById("txStatus");

  let provider = null;
  let signer = null;
  let gmContract = null;
  let connectedAccount = null;
  let currentChainId = null;

  const chainName = (chainId) => ({
    8453: "Base Mainnet (8453)",
    84532: "Base Sepolia (84532)",
    1: "Ethereum Mainnet",
  }[chainId] || `Chain ${chainId}`);

  const setStatus = (t) => statusText.textContent = t;
  const setAccount = (t) => accountText.textContent = t;
  const setChain = (t) => chainText.textContent = t;
  const setFee = (t) => feeEthText.textContent = t;
  const setTx = (t) => txStatus.textContent = t;

  async function connect() {
  if (!window.ethereum) return alert("Zainstaluj MetaMask.");

  try {
    await window.ethereum.request({ method: "eth_requestAccounts" });

    // ✅ 1. Provider RPC Base Sepolia — bez ENS
    const rpcProvider = new ethers.JsonRpcProvider("https://sepolia.base.org");

    // ✅ 2. BrowserProvider tylko do podpisywania
    const browserProvider = new ethers.BrowserProvider(window.ethereum);
    const signer = await browserProvider.getSigner();
    const connectedAccount = await signer.getAddress();

    // ✅ 3. Kontrakt przez RPC, ale podpisywany przez signer
    gmContract = new ethers.Contract(GM_CONTRACT_ADDRESS, GM_ABI, signer);

    const net = await browserProvider.getNetwork();

    setStatus("Połączony");
    setAccount(connectedAccount);
    setChain(chainName(net.chainId));
    connectBtn.disabled = true;
    disconnectBtn.disabled = false;
    fetchFeeBtn.disabled = false;
    sayGmBtn.disabled = false;
  } catch (e) {
    console.error(e);
    setStatus("Błąd połączenia: " + (e.reason || e.message));
  }
}

  function disconnect() {
    try {
      window.ethereum?.removeListener("accountsChanged", handleAccountsChanged);
      window.ethereum?.removeListener("chainChanged", handleChainChanged);
    } catch (e) { /* ignore */ }

    provider = signer = gmContract = null;
    connectedAccount = null;
    currentChainId = null;

    setStatus("Niepołączony");
    setAccount("—");
    setChain("—");
    setFee("—");
    setTx("—");

    connectBtn.disabled = false;
    disconnectBtn.disabled = true;
    fetchFeeBtn.disabled = true;
    sayGmBtn.disabled = true;
  }

  // handlers - use data from event directly, avoid provider.getNetwork() calls
  async function handleAccountsChanged(accounts) {
    if (!accounts || accounts.length === 0) {
      disconnect();
    } else {
      connectedAccount = accounts[0];
      setAccount(connectedAccount);
      // re-init signer + contract
      try {
        // re-create provider+signer to be safe
        provider = new ethers.BrowserProvider(window.ethereum, { name: currentChainId ? (currentChainId===84532?"base-sepolia":"base-mainnet") : "custom", chainId: currentChainId || 0 });
        signer = await provider.getSigner();
        gmContract = new ethers.Contract(GM_CONTRACT_ADDRESS, GM_ABI, signer);
      } catch (e) {
        console.error("accountsChanged handler error", e);
      }
    }
  }

  function handleChainChanged(chainIdHex) {
    // chainIdHex e.g. "0x14888"
    try {
      const parsed = parseInt(chainIdHex, 16);
      currentChainId = parsed;
      setChain(chainName(parsed));
      setFee("—");
      setTx("—");
      // re-init provider+signer for new chain
      provider = new ethers.BrowserProvider(window.ethereum, {
        name: parsed === 84532 ? "base-sepolia" : (parsed === 8453 ? "base-mainnet" : "custom"),
        chainId: parsed
      });
      provider.getSigner().then(s => { signer = s; gmContract = new ethers.Contract(GM_CONTRACT_ADDRESS, GM_ABI, signer); }).catch(()=>{});
    } catch (e) {
      console.error("handleChainChanged parse error", e);
    }
  }

  // Fetch fee view (calls contract view function)
  async function fetchFee() {
    if (!gmContract) { setStatus("Brak kontraktu — połącz MetaMask"); return null; }
    try {
      setStatus("Pobieram opłatę z kontraktu...");
      setTx("—");
      const feeWei = await gmContract.getGmFeeInEth();
      const feeEth = ethers.formatEther(feeWei);
      setFee(feeEth);
      setStatus("Opłata pobrana");
      return feeWei;
    } catch (e) {
      console.error("fetchFee error", e);
      setStatus("Błąd pobierania opłaty: " + (e?.message || e));
      setFee("—");
      return null;
    }
  }

  // Send sayGM with value
  async function sayGm() {
    if (!gmContract) { setStatus("Brak kontraktu — połącz najpierw"); return; }
    try {
      sayGmBtn.disabled = true;
      fetchFeeBtn.disabled = true;
      setStatus("Przygotowuję transakcję...");
      const feeWei = await fetchFee();
      if (!feeWei) throw new Error("Nie udało się pobrać fee");
      setStatus(`Wysyłam tx (value ${ethers.formatEther(feeWei)} ETH)...`);
      const tx = await gmContract.sayGM({ value: feeWei });
      setTx("Wysłano: " + tx.hash);
      setStatus("Czekam na potwierdzenie...");
      await tx.wait();
      setStatus("Say GM zakończone sukcesem ✅");
      setTx("Potwierdzono: " + tx.hash);
    } catch (e) {
      console.error("sayGm error", e);
      // pokaż możliwie czytelny komunikat
      const msg = e?.reason || e?.data?.message || e?.message || String(e);
      setStatus("Błąd wysyłki: " + msg);
    } finally {
      sayGmBtn.disabled = false;
      fetchFeeBtn.disabled = false;
    }
  }

  // button handlers
  connectBtn.addEventListener("click", connect);
  disconnectBtn.addEventListener("click", disconnect);
  fetchFeeBtn.addEventListener("click", fetchFee);
  sayGmBtn.addEventListener("click", sayGm);

  // init: auto-check if already connected (without triggering ENS ops)
  (async function initCheck() {
    if (!window.ethereum) {
      setStatus("MetaMask not found. Zainstaluj MetaMask.");
      return;
    }
    try {
      const accounts = await window.ethereum.request({ method: "eth_accounts" });
      if (accounts && accounts.length > 0) {
        // set minimal UI and allow manual connect to re-init provider safely
        setStatus("MetaMask wykryty, konto połączone lokalnie. Kliknij 'Połącz MetaMask' by dApp zainicjował połączenie.");
        accountText.textContent = accounts[0];
        connectBtn.disabled = false;
      } else {
        setStatus("MetaMask wykryty, ale brak sesji. Kliknij 'Połącz MetaMask'.");
      }
    } catch (e) {
      setStatus("Gotowy do połączenia z MetaMask");
    }
  })();

})();
</script>
</body>
</html>
